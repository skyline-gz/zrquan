<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <title>头像上传测试 - 职人圈</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--&lt;!&ndash;[if lt IE 9]>-->
    <!--<script src="../vendors/html5shiv/html5shiv.js"></script>-->
    <!--<![endif]&ndash;&gt;-->
    <!--<link rel="stylesheet" type="text/css" href="../css/zrquan.css">-->
    <script src="../vendors/jquery/jquery-1.11.1.js"></script>
    <script src="../vendors/jcorp/jquery.jcrop-0.9.12.js"></script>
    <script type="text/javascript">
        tempAvatarUrl = null;

        $(document).ready(function() {
            $("#image_file").change(fileSelectHandler);

            $("#btnSubmit").click(function () {
                $("form")[0].submit();
            });

//            $("btnGetSubmitImg").click(function(){
//               $("#jcrop_target").attr("src", tempAvatarUrl);
//            });

            $('#jcrop_target').Jcrop({
                onChange: showCoords,
                onSelect: showCoords
            });

            function showCoords(c) {
                if(console)
                    console.log(c.x + " " + c.y + " " + c.x2 + " " + c.y2 + " " + c.w + " " + c.h);
//                $('#x').val(c.x);
//                $('#y').val(c.y);
//                $('#x2').val(c.x2);
//                $('#y2').val(c.y2);
//                $('#w').val(c.w);
//                $('#h').val(c.h);
            }

            // convert bytes into friendly format
            function bytesToSize(bytes) {
                var sizes = ['Bytes', 'KB', 'MB'];
                if (bytes == 0) return 'n/a';
                var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
            }

            // check for selected crop region
            function checkForm() {
                if (parseInt($('#w').val())) return true;
                $('.error').html('Please select a crop region and then press Upload').show();
                return false;
            }

            function fileSelectHandler() {

                // get selected file
                var oFile = $('#image_file')[0].files[0];

                // hide all errors
//                $('.error').hide();

                // check for image type (jpg and png are allowed)
                var rFilter = /^(image\/jpeg|image\/png)$/i;
                if (! rFilter.test(oFile.type)) {
                    $('.error').html('Please select a valid image file (jpg and png are allowed)').show();
                    return;
                }

                // check for file size
//                if (oFile.size > 250 * 1024) {
//                    $('.error').html('You have selected too big file, please select a one smaller image file').show();
//                    return;
//                }

                // preview element
                var oImage = document.getElementById('preview');

                // prepare HTML5 FileReader
                var oReader = new FileReader();
                oReader.onload = function(e) {

                    // e.target.result contains the DataURL which we can use as a source of the image
                    oImage.src = e.target.result;
                    oImage.onload = function () { // onload event handler

                        // display step 2
                        $('.step2').fadeIn(500);

                        // display some basic image info
//                        var sResultFileSize = bytesToSize(oFile.size);
//                        $('#filesize').val(sResultFileSize);
//                        $('#filetype').val(oFile.type);
//                        $('#filedim').val(oImage.naturalWidth + ' x ' + oImage.naturalHeight);

                        // Create variables (in this scope) to hold the Jcrop API and image size
                        var jcrop_api, boundx, boundy;

                        // destroy Jcrop if it is existed
                        if (typeof jcrop_api != 'undefined')
                            jcrop_api.destroy();

                        // initialize Jcrop
                        $('#preview').Jcrop({
                            minSize: [32, 32], // min crop size
                            aspectRatio : 1, // keep aspect ratio 1:1
                            bgFade: true, // use fade effect
                            bgOpacity: .3 // fade opacity
//                            onChange: updateInfo,
//                            onSelect: updateInfo,
//                            onRelease: clearInfo
                        }, function(){

                            // use the Jcrop API to get the real image size
                            var bounds = this.getBounds();
                            boundx = bounds[0];
                            boundy = bounds[1];

                            // Store the Jcrop API in the jcrop_api variable
                            jcrop_api = this;
                        });
                    };
                };

                // read selected file as DataURL
                oReader.readAsDataURL(oFile);
            }
        });
    </script>
</head>
<body>
    <form target="av_up_frame" method="post" enctype="multipart/form-data" action="http://localhost:3000/upload/upload_avatar">
        <label for="avt_file"></label>
        <input type="file" accept="image/*" name="picture" id="avt_file">
        <input type="hidden" name="handle_mode" value="upload">
        <input type="hidden" name="type" value="1">
        <input type="hidden" name="dest_id" value="668baec661da36f56ad735997c001dd8">
        <input type="hidden" name="return_size" value="l">
    </form>
    <button id="btnSubmit">提交</button>

    <button id="btnGetSubmitImg">获取图像</button>

    <img id="jcrop_target" src="../images/big-icons/qq.png" height="300"/>

    <h2>Step1: 请选择一张图片</h2>
    <div><input type="file" name="image_file" id="image_file" /></div>
    <img id="preview" />

    <!--隐藏的iframe，用于处理头像上传的请求-->
    <iframe id="av_up_frame" name="av_up_frame" style="position: absolute; height: 0px; width: 0px; left: -9000px;"></iframe>
</body>
</html>